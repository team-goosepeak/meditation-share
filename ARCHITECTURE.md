# Worship Reflection ì•„í‚¤í…ì²˜ ë¬¸ì„œ

## ğŸ“ ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### ì‹œìŠ¤í…œ ê°œìš”

Worship ReflectionëŠ” **3-Tier ì•„í‚¤í…ì²˜**ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„¤ê³„ëœ í’€ìŠ¤íƒ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Presentation Layer (Frontend)       â”‚
â”‚         Next.js 14 + React + TypeScript     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ HTTP/REST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Application Layer (API)             â”‚
â”‚         Supabase Client SDK                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ PostgreSQL Protocol
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Data Layer (Database + Auth)        â”‚
â”‚         Supabase (PostgreSQL + Auth)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ê¸°ìˆ  ìŠ¤íƒ ì„ íƒ ê·¼ê±°

1. **Next.js 14 (App Router)**
   - Server-Side Rendering (SSR)ê³¼ Static Generationì„ í†µí•œ SEO ìµœì í™”
   - App Routerì˜ ë ˆì´ì•„ì›ƒ ì‹œìŠ¤í…œìœ¼ë¡œ íš¨ìœ¨ì ì¸ UI êµ¬ì¡°í™”
   - API Routes ì—†ì´ ì§ì ‘ Supabaseì™€ í†µì‹ í•˜ì—¬ ê°„ê²°í•œ ì•„í‚¤í…ì²˜
   - React Server Componentsë¡œ ì´ˆê¸° ë¡œë”© ì„±ëŠ¥ ê°œì„ 

2. **Supabase**
   - PostgreSQL ê¸°ë°˜ì˜ í™•ì¥ ê°€ëŠ¥í•œ ë°ì´í„°ë² ì´ìŠ¤
   - Row Level Security (RLS)ë¥¼ í†µí•œ ë°ì´í„° ì ‘ê·¼ ì œì–´
   - ì‹¤ì‹œê°„ êµ¬ë… ê¸°ëŠ¥ (í–¥í›„ í™œìš© ê°€ëŠ¥)
   - ë‚´ì¥ ì¸ì¦ ì‹œìŠ¤í…œìœ¼ë¡œ ê°œë°œ ì‹œê°„ ë‹¨ì¶•
   - ìë™ API ìƒì„±ìœ¼ë¡œ ë°±ì—”ë“œ ê°œë°œ ìµœì†Œí™”

3. **TypeScript**
   - ì»´íŒŒì¼ íƒ€ì„ íƒ€ì… ì²´í¬ë¡œ ëŸ°íƒ€ì„ ì˜¤ë¥˜ ì‚¬ì „ ë°©ì§€
   - IDE ìë™ì™„ì„±ìœ¼ë¡œ ê°œë°œ ìƒì‚°ì„± í–¥ìƒ
   - ëª…ì‹œì  íƒ€ì… ì •ì˜ë¡œ ì½”ë“œ ê°€ë…ì„± ë° ìœ ì§€ë³´ìˆ˜ì„± ê°œì„ 

4. **Tailwind CSS**
   - ìœ í‹¸ë¦¬í‹° ìš°ì„  ì ‘ê·¼ìœ¼ë¡œ ë¹ ë¥¸ UI ê°œë°œ
   - ì¼ê´€ëœ ë””ìì¸ ì‹œìŠ¤í…œ êµ¬ì¶•
   - ë²ˆë“¤ í¬ê¸° ìµœì í™” (ë¯¸ì‚¬ìš© CSS ìë™ ì œê±°)

---

## ğŸ— í”„ë¡œì íŠ¸ êµ¬ì¡° ë° ì„¤ê³„ ì›ì¹™

### ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
meditation-share/
â”œâ”€â”€ app/                           # Next.js App Router í˜ì´ì§€
â”‚   â”œâ”€â”€ layout.tsx                # ë£¨íŠ¸ ë ˆì´ì•„ì›ƒ (ì „ì—­ ì„¤ì •)
â”‚   â”œâ”€â”€ page.tsx                  # ëœë”© í˜ì´ì§€
â”‚   â”œâ”€â”€ globals.css               # ì „ì—­ ìŠ¤íƒ€ì¼
â”‚   â”‚
â”‚   â”œâ”€â”€ auth/                     # ì¸ì¦ ê´€ë ¨ í˜ì´ì§€ ê·¸ë£¹
â”‚   â”‚   â”œâ”€â”€ login/page.tsx       # ë¡œê·¸ì¸ í˜ì´ì§€
â”‚   â”‚   â””â”€â”€ signup/page.tsx      # íšŒì›ê°€ì… í˜ì´ì§€
â”‚   â”‚
â”‚   â”œâ”€â”€ feed/                     # í”¼ë“œ í˜ì´ì§€
â”‚   â”‚   â””â”€â”€ page.tsx             # ë©”ì¸ íƒ€ì„ë¼ì¸
â”‚   â”‚
â”‚   â”œâ”€â”€ posts/                    # í¬ìŠ¤íŠ¸ ê´€ë ¨ í˜ì´ì§€
â”‚   â”‚   â”œâ”€â”€ new/page.tsx         # ìƒˆ í¬ìŠ¤íŠ¸ ì‘ì„±
â”‚   â”‚   â””â”€â”€ [id]/page.tsx        # í¬ìŠ¤íŠ¸ ìƒì„¸ (ë™ì  ë¼ìš°íŒ…)
â”‚   â”‚
â”‚   â”œâ”€â”€ churches/                 # êµíšŒ ê´€ë ¨ í˜ì´ì§€
â”‚   â”‚   â”œâ”€â”€ page.tsx             # êµíšŒ ëª©ë¡
â”‚   â”‚   â”œâ”€â”€ new/page.tsx         # ìƒˆ êµíšŒ ìƒì„±
â”‚   â”‚   â””â”€â”€ [id]/page.tsx        # êµíšŒ ìƒì„¸
â”‚   â”‚
â”‚   â””â”€â”€ onboarding/               # ì˜¨ë³´ë”© í”Œë¡œìš°
â”‚       â””â”€â”€ page.tsx             # 3ë‹¨ê³„ ì˜¨ë³´ë”©
â”‚
â”œâ”€â”€ components/                    # ì¬ì‚¬ìš© ê°€ëŠ¥í•œ UI ì»´í¬ë„ŒíŠ¸
â”‚   â”œâ”€â”€ Layout.tsx                # ì¸ì¦ëœ ì‚¬ìš©ììš© ë ˆì´ì•„ì›ƒ
â”‚   â””â”€â”€ PostCard.tsx              # í¬ìŠ¤íŠ¸ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
â”‚
â”œâ”€â”€ lib/                          # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë° ìœ í‹¸ë¦¬í‹°
â”‚   â”œâ”€â”€ supabase.ts               # Supabase í´ë¼ì´ì–¸íŠ¸ & íƒ€ì… ì •ì˜
â”‚   â”œâ”€â”€ auth.ts                   # ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜
â”‚   â”‚
â”‚   â””â”€â”€ api/                      # ë„ë©”ì¸ë³„ API í•¨ìˆ˜ ê·¸ë£¹
â”‚       â”œâ”€â”€ posts.ts              # í¬ìŠ¤íŠ¸ CRUD ë° ì¡°íšŒ
â”‚       â”œâ”€â”€ comments.ts           # ëŒ“ê¸€ CRUD
â”‚       â”œâ”€â”€ reactions.ts          # ë¦¬ì•¡ì…˜ ì¶”ê°€/ì œê±°
â”‚       â””â”€â”€ churches.ts           # êµíšŒ ê´€ë¦¬
â”‚
â””â”€â”€ supabase/
    â””â”€â”€ migrations/               # ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë²„ì „ ê´€ë¦¬
        â”œâ”€â”€ 001_initial_schema.sql      # ì´ˆê¸° ìŠ¤í‚¤ë§ˆ
        â””â”€â”€ 002_fix_rls_policies.sql    # RLS ì •ì±… ìˆ˜ì •
```

### ì„¤ê³„ ì›ì¹™

#### 1. **ë„ë©”ì¸ ê¸°ë°˜ êµ¬ì¡°í™” (Domain-Driven Structure)**

ê° ë¹„ì¦ˆë‹ˆìŠ¤ ë„ë©”ì¸(í¬ìŠ¤íŠ¸, êµíšŒ, ëŒ“ê¸€ ë“±)ì„ ë…ë¦½ì ì¸ ëª¨ë“ˆë¡œ ë¶„ë¦¬í•˜ì—¬ ê´€ë¦¬í•©ë‹ˆë‹¤:

```
lib/api/
  â”œâ”€â”€ posts.ts      â†’ í¬ìŠ¤íŠ¸ ê´€ë ¨ ëª¨ë“  ë¡œì§
  â”œâ”€â”€ comments.ts   â†’ ëŒ“ê¸€ ê´€ë ¨ ëª¨ë“  ë¡œì§
  â”œâ”€â”€ reactions.ts  â†’ ë¦¬ì•¡ì…˜ ê´€ë ¨ ëª¨ë“  ë¡œì§
  â””â”€â”€ churches.ts   â†’ êµíšŒ ê´€ë ¨ ëª¨ë“  ë¡œì§
```

**ì¥ì :**
- ê¸°ëŠ¥ ì¶”ê°€/ìˆ˜ì • ì‹œ í•´ë‹¹ ë„ë©”ì¸ íŒŒì¼ë§Œ ìˆ˜ì •
- ì½”ë“œ ì¶©ëŒ ìµœì†Œí™”
- íŒ€ í˜‘ì—… ì‹œ ì—­í•  ë¶„ë‹´ ìš©ì´

#### 2. **ì»´í¬ë„ŒíŠ¸ ì¬ì‚¬ìš© ì›ì¹™ (Component Reusability)**

UI ì»´í¬ë„ŒíŠ¸ëŠ” ë‹¤ìŒ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤:

- **Page Components** (`app/` ë””ë ‰í† ë¦¬): ë¼ìš°íŒ…ê³¼ ì§ì ‘ ì—°ê²°ëœ ì»´í¬ë„ŒíŠ¸
- **Shared Components** (`components/` ë””ë ‰í† ë¦¬): ì—¬ëŸ¬ í˜ì´ì§€ì—ì„œ ì¬ì‚¬ìš©ë˜ëŠ” ì»´í¬ë„ŒíŠ¸

```typescript
// ì˜ˆ: PostCardëŠ” feed, êµíšŒ ìƒì„¸, í”„ë¡œí•„ ë“± ì—¬ëŸ¬ ê³³ì—ì„œ ì¬ì‚¬ìš©
<PostCard post={post} onReactionUpdate={reload} />
```

#### 3. **íƒ€ì… ì•ˆì •ì„± (Type Safety)**

ëª¨ë“  ë°ì´í„° ëª¨ë¸ì€ `lib/supabase.ts`ì—ì„œ ì¤‘ì•™ ê´€ë¦¬í•©ë‹ˆë‹¤:

```typescript
export type Post = {
  id: string
  author_id: string
  title: string
  body: string
  // ... ëª¨ë“  í•„ë“œ ëª…ì‹œ
}
```

**ì ìš© ë°©ë²•:**
- ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆì™€ TypeScript íƒ€ì…ì„ 1:1 ë§¤ì¹­
- API í•¨ìˆ˜ì˜ ì…ë ¥/ì¶œë ¥ íƒ€ì… ëª…ì‹œ
- ì»´íŒŒì¼ ì‹œì ì— íƒ€ì… ë¶ˆì¼ì¹˜ ê°ì§€

#### 4. **í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë°ì´í„° í˜ì¹­ (Client-Side Data Fetching)**

ì´ í”„ë¡œì íŠ¸ëŠ” ëŒ€ë¶€ë¶„ì˜ í˜ì´ì§€ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë Œë”ë§(CSR)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:

```typescript
'use client'  // í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ ëª…ì‹œ

const [posts, setPosts] = useState<Post[]>([])

useEffect(() => {
  loadPosts()
}, [])

async function loadPosts() {
  const data = await getPosts()
  setPosts(data)
}
```

**ì„ íƒ ì´ìœ :**
- ì‚¬ìš©ìë³„ ë§ì¶¤ ì½˜í…ì¸  (ì¸ì¦ ìƒíƒœ ê¸°ë°˜)
- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ê°€ëŠ¥ì„± (í–¥í›„)
- ì¸í„°ë™ì…˜ì´ ë§ì€ ì†Œì…œ í”Œë«í¼ íŠ¹ì„±

---

## ğŸ—„ ë°ì´í„°ë² ì´ìŠ¤ ì•„í‚¤í…ì²˜

### ERD (Entity Relationship Diagram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   profiles  â”‚         â”‚  churches   â”‚
â”‚             â”‚         â”‚             â”‚
â”‚ - id (PK)   â”‚         â”‚ - id (PK)   â”‚
â”‚ - email     â”‚         â”‚ - name      â”‚
â”‚ - name      â”‚         â”‚ - join_code â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚  â”‚
       â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â””â”€â”€â”¼â”€â”€â”‚ church_members   â”‚
          â”‚  â”‚                  â”‚
          â”‚  â”‚ - church_id (FK) â”‚
          â”‚  â”‚ - user_id (FK)   â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â””â”€â”€â”‚     posts        â”‚
             â”‚                  â”‚
             â”‚ - id (PK)        â”‚
             â”‚ - author_id (FK) â”‚
             â”‚ - church_id (FK) â”‚
             â”‚ - visibility     â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚           â”‚           â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ comments â”‚ â”‚reactionsâ”‚ â”‚bookmarksâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### í…Œì´ë¸” ì„¤ê³„ ìƒì„¸

#### 1. **profiles** (ì‚¬ìš©ì í”„ë¡œí•„)
```sql
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  display_name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  avatar_url TEXT,
  bio TEXT,
  role TEXT DEFAULT 'member',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**ì„¤ê³„ ê²°ì •:**
- Supabase Authì˜ `auth.users`ì™€ 1:1 ê´€ê³„
- `id`ë¥¼ ì™¸ë˜í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ê³¼ í”„ë¡œí•„ ìë™ ì—°ê²°
- `role` í•„ë“œë¡œ ê¶Œí•œ ê´€ë¦¬ (member/pastor/admin)

#### 2. **churches** (êµíšŒ)
```sql
CREATE TABLE public.churches (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  address TEXT,
  description TEXT,
  pastor_id UUID REFERENCES public.profiles(id),
  join_code TEXT UNIQUE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**ì„¤ê³„ ê²°ì •:**
- `join_code`: 8ìë¦¬ ë¬´ì‘ìœ„ ì½”ë“œë¡œ êµíšŒ ì´ˆëŒ€ ê¸°ëŠ¥ êµ¬í˜„
- `pastor_id`: êµíšŒ ìƒì„±ì ì¶”ì  (í–¥í›„ ê´€ë¦¬ì ê¶Œí•œ í™•ì¥ ê°€ëŠ¥)
- UNIQUE ì œì•½ìœ¼ë¡œ ì¤‘ë³µ ì´ˆëŒ€ ì½”ë“œ ë°©ì§€

#### 3. **church_members** (êµíšŒ ë©¤ë²„ì‹­ - ë‹¤ëŒ€ë‹¤ ê´€ê³„)
```sql
CREATE TABLE public.church_members (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  church_id UUID REFERENCES public.churches(id) ON DELETE CASCADE,
  user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
  role TEXT DEFAULT 'member',
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(church_id, user_id)
);
```

**ì„¤ê³„ ê²°ì •:**
- ì‚¬ìš©ì-êµíšŒ ë‹¤ëŒ€ë‹¤ ê´€ê³„ (í•œ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ êµíšŒ ê°€ì… ê°€ëŠ¥)
- `UNIQUE(church_id, user_id)`: ì¤‘ë³µ ê°€ì… ë°©ì§€
- `ON DELETE CASCADE`: êµíšŒë‚˜ ì‚¬ìš©ì ì‚­ì œ ì‹œ ë©¤ë²„ì‹­ë„ ìë™ ì‚­ì œ

#### 4. **posts** (í¬ìŠ¤íŠ¸)
```sql
CREATE TABLE public.posts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  author_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
  church_id UUID REFERENCES public.churches(id) ON DELETE SET NULL,
  title TEXT NOT NULL,
  body TEXT NOT NULL,
  scriptures JSONB DEFAULT '[]'::jsonb,
  tags TEXT[] DEFAULT '{}',
  visibility TEXT DEFAULT 'public',
  sermon_date DATE,
  sermon_location TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**ì„¤ê³„ ê²°ì •:**
- `scriptures JSONB`: ì—¬ëŸ¬ ì„±ê²½ êµ¬ì ˆì„ ìœ ì—°í•˜ê²Œ ì €ì¥
  ```json
  [
    {"book": "ìš”í•œë³µìŒ", "chapter": 3, "verseFrom": 16, "verseTo": 18}
  ]
  ```
- `tags TEXT[]`: PostgreSQL ë°°ì—´ íƒ€ì…ìœ¼ë¡œ íƒœê·¸ ê´€ë¦¬
- `visibility`: ê³µê°œ ë²”ìœ„ ì œì–´ (public/church/friends/private)
- `church_id ON DELETE SET NULL`: êµíšŒ ì‚­ì œ ì‹œ í¬ìŠ¤íŠ¸ëŠ” ìœ ì§€

### Row Level Security (RLS) ì •ì±…

#### ë¬¸ì œ ìƒí™©ê³¼ í•´ê²°

**ë°œìƒí•œ ë¬¸ì œ:**
```sql
-- âŒ ì˜ëª»ëœ ì •ì±… (ë¬´í•œ ì¬ê·€ ë°œìƒ)
CREATE POLICY "Church members are viewable by church members"
  ON public.church_members FOR SELECT
  USING (
    church_id IN (
      SELECT church_id FROM public.church_members WHERE user_id = auth.uid()
    )
  );
```

`church_members` í…Œì´ë¸”ì˜ SELECT ì •ì±…ì´ ë‹¤ì‹œ `church_members` í…Œì´ë¸”ì„ ì¡°íšŒí•˜ë©´ì„œ **ë¬´í•œ ì¬ê·€**ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

**í•´ê²° ë°©ë²•:**
```sql
-- âœ… ìˆ˜ì •ëœ ì •ì±… (ì¬ê·€ ë°©ì§€)
CREATE POLICY "Users can view their own memberships"
  ON public.church_members FOR SELECT
  USING (user_id = auth.uid());

CREATE POLICY "Users can view members of their churches"
  ON public.church_members FOR SELECT
  USING (
    church_id IN (
      SELECT cm.church_id 
      FROM public.church_members cm 
      WHERE cm.user_id = auth.uid()
    )
  );
```

**í•µì‹¬ ê°œì„ ì‚¬í•­:**
1. **ì •ì±… ë¶„ë¦¬**: ìê¸° ìì‹ ì˜ ë©¤ë²„ì‹­ê³¼ ê°™ì€ êµíšŒ ë©¤ë²„ ì¡°íšŒë¥¼ ë³„ë„ ì •ì±…ìœ¼ë¡œ ë¶„ë¦¬
2. **ëª…ì‹œì  í…Œì´ë¸” ë³„ì¹­**: `cm`ì„ ì‚¬ìš©í•˜ì—¬ ì„œë¸Œì¿¼ë¦¬ì™€ ë©”ì¸ ì¿¼ë¦¬ë¥¼ ëª…í™•íˆ êµ¬ë¶„
3. **ê°„ë‹¨í•œ ì²« ë²ˆì§¸ ì •ì±…**: `user_id = auth.uid()`ëŠ” ì¬ê·€ ì—†ì´ ì¦‰ì‹œ í‰ê°€ ê°€ëŠ¥

#### RLS ì •ì±… êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Client Request                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Supabase Auth (JWT Token Validation)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ auth.uid()
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL + RLS Policies                â”‚
â”‚                                            â”‚
â”‚   1. ìš”ì²­ í…Œì´ë¸”ì˜ ì •ì±… í™•ì¸                â”‚
â”‚   2. USING ì ˆ í‰ê°€                         â”‚
â”‚   3. ì¡°ê±´ ë§Œì¡± ì‹œì—ë§Œ ë°ì´í„° ë°˜í™˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ê° í…Œì´ë¸”ì˜ RLS ì •ì±… ì „ëµ:**

1. **profiles**: ëª¨ë“  í”„ë¡œí•„ì€ ê³µê°œ, ë³¸ì¸ë§Œ ìˆ˜ì • ê°€ëŠ¥
2. **churches**: ëª¨ë“  êµíšŒëŠ” ê³µê°œ (ê²€ìƒ‰ ê°€ëŠ¥), ëª©íšŒìë§Œ ìˆ˜ì •
3. **church_members**: ë³¸ì¸ ë©¤ë²„ì‹­ + ê°™ì€ êµíšŒ ë©¤ë²„ ì¡°íšŒ ê°€ëŠ¥
4. **posts**: visibilityì— ë”°ë¼ ì ‘ê·¼ ì œì–´
   - `public`: ëª¨ë‘ ì¡°íšŒ ê°€ëŠ¥
   - `church`: ê°™ì€ êµíšŒ ë©¤ë²„ë§Œ ì¡°íšŒ ê°€ëŠ¥
   - `friends`: íŒ”ë¡œìš° ê´€ê³„ë§Œ ì¡°íšŒ ê°€ëŠ¥
   - `private`: ì‘ì„±ìë§Œ ì¡°íšŒ ê°€ëŠ¥

---

## ğŸ” ì¸ì¦ ë° ê¶Œí•œ ê´€ë¦¬

### ì¸ì¦ í”Œë¡œìš°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  íšŒì›ê°€ì…     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Auth: ì‚¬ìš©ì ìƒì„±        â”‚
â”‚ - email/password ì €ì¥             â”‚
â”‚ - JWT í† í° ë°œê¸‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ (Trigger: on_auth_user_created)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ profiles í…Œì´ë¸”: ìë™ ë ˆì½”ë“œ ìƒì„±  â”‚
â”‚ - display_name ì„¤ì •              â”‚
â”‚ - email ë³µì‚¬                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì˜¨ë³´ë”© í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸         â”‚
â”‚ - í”„ë¡œí•„ ì™„ì„±                     â”‚
â”‚ - êµíšŒ ê°€ì… (ì„ íƒ)                â”‚
â”‚ - ê´€ì‹¬ì‚¬ ì„ íƒ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### êµ¬í˜„ ìƒì„¸

#### 1. íšŒì›ê°€ì… í•¨ìˆ˜
```typescript
// lib/auth.ts
export async function signUp(email: string, password: string, displayName: string) {
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: {
        display_name: displayName,  // ë©”íƒ€ë°ì´í„°ë¡œ ì „ë‹¬
      },
    },
  })
  
  if (error) throw error
  return data
}
```

#### 2. ìë™ í”„ë¡œí•„ ìƒì„± íŠ¸ë¦¬ê±°
```sql
-- supabase/migrations/001_initial_schema.sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, display_name, email)
  VALUES (
    new.id, 
    new.raw_user_meta_data->>'display_name', 
    new.email
  );
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

**ì„¤ê³„ ì´ìœ :**
- ì¸ì¦(auth.users)ê³¼ í”„ë¡œí•„(profiles)ì„ ë¶„ë¦¬í•˜ì—¬ í™•ì¥ì„± í™•ë³´
- íŠ¸ë¦¬ê±°ë¡œ ìë™í™”í•˜ì—¬ ìˆ˜ë™ ì—ëŸ¬ ë°©ì§€
- `SECURITY DEFINER`ë¡œ RLS ìš°íšŒ (ì‹œìŠ¤í…œ ì‘ì—…)

#### 3. ì„¸ì…˜ ê´€ë¦¬

```typescript
// components/Layout.tsx
useEffect(() => {
  checkAuth()
}, [])

async function checkAuth() {
  const currentUser = await getCurrentUser()
  if (!currentUser) {
    router.push('/auth/login')  // ë¯¸ì¸ì¦ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
  }
}
```

---

## ğŸ“¡ API ë ˆì´ì–´ ì„¤ê³„

### API í•¨ìˆ˜ êµ¬ì¡°í™” ì›ì¹™

ê° ë„ë©”ì¸ë³„ API íŒŒì¼ì€ ë‹¤ìŒ íŒ¨í„´ì„ ë”°ë¦…ë‹ˆë‹¤:

```typescript
// lib/api/posts.ts êµ¬ì¡° ì˜ˆì‹œ

// 1. ìƒì„± (Create)
export async function createPost(data: CreatePostData): Promise<Post> {
  // í˜„ì¬ ì‚¬ìš©ì í™•ì¸
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) throw new Error('User not authenticated')
  
  // ë°ì´í„° ì‚½ì…
  const { data, error } = await supabase
    .from('posts')
    .insert({ ...data, author_id: user.id })
    .select('*, author:profiles(*), church:churches(*)')
    .single()
  
  if (error) throw error
  return data
}

// 2. ì¡°íšŒ (Read)
export async function getPosts(options: GetPostsOptions): Promise<Post[]> {
  let query = supabase
    .from('posts')
    .select('*, author:profiles(*), church:churches(*)')
    .order('created_at', { ascending: false })
  
  // í•„í„° ì ìš©
  if (options.churchId) {
    query = query.eq('church_id', options.churchId)
  }
  
  // í˜ì´ì§€ë„¤ì´ì…˜
  if (options.limit) {
    query = query.range(options.offset, options.offset + options.limit - 1)
  }
  
  const { data, error } = await query
  if (error) throw error
  
  // ê´€ê³„ ë°ì´í„° ì¶”ê°€ (ë¦¬ì•¡ì…˜, ëŒ“ê¸€ ì¹´ìš´íŠ¸)
  return await enrichPostsWithCounts(data)
}

// 3. ìˆ˜ì • (Update)
export async function updatePost(postId: string, updates: Partial<Post>): Promise<Post> {
  const { data, error } = await supabase
    .from('posts')
    .update(updates)
    .eq('id', postId)
    .select()
    .single()
  
  if (error) throw error
  return data
}

// 4. ì‚­ì œ (Delete)
export async function deletePost(postId: string): Promise<void> {
  const { error } = await supabase
    .from('posts')
    .delete()
    .eq('id', postId)
  
  if (error) throw error
}
```

### ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì „ëµ

#### 1. **Eager Loading (ì¦‰ì‹œ ë¡œë”©)**

ê´€ë ¨ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ê°€ì ¸ì˜µë‹ˆë‹¤:

```typescript
const { data } = await supabase
  .from('posts')
  .select(`
    *,
    author:profiles(*),
    church:churches(*)
  `)
```

**ì¥ì :**
- N+1 ì¿¼ë¦¬ ë¬¸ì œ ë°©ì§€
- ë„¤íŠ¸ì›Œí¬ ì™•ë³µ ìµœì†Œí™”

#### 2. **Count ì¿¼ë¦¬ ë¶„ë¦¬**

ë¦¬ì•¡ì…˜ê³¼ ëŒ“ê¸€ ìˆ˜ëŠ” ë³„ë„ë¡œ ì§‘ê³„:

```typescript
async function enrichPostsWithCounts(posts: Post[]) {
  return await Promise.all(
    posts.map(async (post) => {
      // ë¦¬ì•¡ì…˜ ì¹´ìš´íŠ¸
      const { data: reactions } = await supabase
        .from('reactions')
        .select('type')
        .eq('post_id', post.id)
      
      // ëŒ“ê¸€ ì¹´ìš´íŠ¸
      const { count } = await supabase
        .from('comments')
        .select('*', { count: 'exact', head: true })
        .eq('post_id', post.id)
      
      return {
        ...post,
        reactions_count: aggregateReactions(reactions),
        comments_count: count || 0
      }
    })
  )
}
```

**ì´ìœ :**
- ë©”ì¸ ì¿¼ë¦¬ ë³µì¡ë„ ê°ì†Œ
- ìœ ì—°í•œ ì§‘ê³„ ë¡œì§

---

## ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ì•„í‚¤í…ì²˜

### í˜ì´ì§€ ë¼ìš°íŒ… êµ¬ì¡°

Next.js App Routerì˜ íŒŒì¼ ì‹œìŠ¤í…œ ê¸°ë°˜ ë¼ìš°íŒ…:

```
app/
â”œâ”€â”€ page.tsx                    â†’ /
â”œâ”€â”€ feed/page.tsx              â†’ /feed
â”œâ”€â”€ posts/
â”‚   â”œâ”€â”€ new/page.tsx          â†’ /posts/new
â”‚   â””â”€â”€ [id]/page.tsx         â†’ /posts/:id
â””â”€â”€ churches/
    â”œâ”€â”€ page.tsx              â†’ /churches
    â”œâ”€â”€ new/page.tsx          â†’ /churches/new
    â””â”€â”€ [id]/page.tsx         â†’ /churches/:id
```

**ë™ì  ë¼ìš°íŒ… ì²˜ë¦¬:**
```typescript
// app/posts/[id]/page.tsx
export default function PostDetailPage() {
  const params = useParams()
  const postId = params.id as string
  
  // postIdë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ë¡œë“œ
}
```

### ìƒíƒœ ê´€ë¦¬ ì „ëµ

ì´ í”„ë¡œì íŠ¸ëŠ” **ë¡œì»¬ ìƒíƒœ ê´€ë¦¬**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤ (Redux/Zustand ì—†ìŒ):

```typescript
// í˜ì´ì§€ ë ˆë²¨ì—ì„œ ìƒíƒœ ê´€ë¦¬
const [posts, setPosts] = useState<Post[]>([])
const [isLoading, setIsLoading] = useState(true)

// ë°ì´í„° ë¡œë“œ
useEffect(() => {
  loadPosts()
}, [filter])

// ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ë¥¼ ìì‹ ì»´í¬ë„ŒíŠ¸ì— ì „ë‹¬
<PostCard 
  post={post} 
  onReactionUpdate={loadPosts}  // ì½œë°±ìœ¼ë¡œ ë¶€ëª¨ ìƒíƒœ ì—…ë°ì´íŠ¸
/>
```

**ì„ íƒ ì´ìœ :**
- ê° í˜ì´ì§€ê°€ ë…ë¦½ì  (ì „ì—­ ìƒíƒœ ê³µìœ  ë¶ˆí•„ìš”)
- ì½”ë“œ ë³µì¡ë„ ê°ì†Œ
- í˜ì´ì§€ ì „í™˜ ì‹œ ìì—°ìŠ¤ëŸ¬ìš´ ë°ì´í„° ìƒˆë¡œê³ ì¹¨

### UI ì»´í¬ë„ŒíŠ¸ íŒ¨í„´

#### 1. **Container/Presentational íŒ¨í„´**

```typescript
// Container: ë°ì´í„° ë¡œì§ (app/feed/page.tsx)
export default function FeedPage() {
  const [posts, setPosts] = useState<Post[]>([])
  
  async function loadPosts() {
    const data = await getPosts()
    setPosts(data)
  }
  
  return (
    <Layout>
      {posts.map(post => (
        <PostCard post={post} onReactionUpdate={loadPosts} />
      ))}
    </Layout>
  )
}

// Presentational: UI ë Œë”ë§ (components/PostCard.tsx)
export default function PostCard({ post, onReactionUpdate }: PostCardProps) {
  async function handleReaction(type: ReactionType) {
    await addReaction(post.id, type)
    onReactionUpdate?.()  // ë¶€ëª¨ì—ê²Œ ì—…ë°ì´íŠ¸ ì•Œë¦¼
  }
  
  return (
    <div className="card">
      {/* UI ë Œë”ë§ */}
    </div>
  )
}
```

#### 2. **ë ˆì´ì•„ì›ƒ ì¤‘ì²©**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  app/layout.tsx (ì „ì—­ ë ˆì´ì•„ì›ƒ)      â”‚
â”‚  - HTML êµ¬ì¡°                        â”‚
â”‚  - ì „ì—­ ìŠ¤íƒ€ì¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ components/Layout.tsx           â”‚â”‚
â”‚  â”‚ - ë„¤ë¹„ê²Œì´ì…˜                     â”‚â”‚
â”‚  â”‚ - ì‚¬ì´ë“œë°”                       â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚ í˜ì´ì§€ ì»¨í…ì¸                â”‚â”‚â”‚
â”‚  â”‚  â”‚ (app/feed/page.tsx ë“±)     â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ì„±ëŠ¥ ìµœì í™” ì „ëµ

### 1. ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤

```sql
CREATE INDEX idx_posts_author_id ON public.posts(author_id);
CREATE INDEX idx_posts_church_id ON public.posts(church_id);
CREATE INDEX idx_posts_created_at ON public.posts(created_at DESC);
```

**íš¨ê³¼:**
- ì‘ì„±ìë³„ í¬ìŠ¤íŠ¸ ì¡°íšŒ ì†ë„ í–¥ìƒ
- êµíšŒë³„ í•„í„°ë§ ì„±ëŠ¥ ê°œì„ 
- ìµœì‹ ìˆœ ì •ë ¬ ìµœì í™”

### 2. ì´ë¯¸ì§€ ìµœì í™” (í–¥í›„)

```typescript
import Image from 'next/image'

<Image
  src={avatarUrl}
  width={40}
  height={40}
  alt="Profile"
/>
```

Next.jsì˜ ìë™ ì´ë¯¸ì§€ ìµœì í™” í™œìš©

### 3. í˜ì´ì§€ë„¤ì´ì…˜

```typescript
const { data } = await supabase
  .from('posts')
  .select('*')
  .range(offset, offset + limit - 1)  // LIMIT & OFFSET
```

í•œ ë²ˆì— 20ê°œì”© ë¡œë“œí•˜ì—¬ ì´ˆê¸° ë¡œë”© ì†ë„ ê°œì„ 

---

## ğŸ”§ ì´ë²ˆ ì˜¤ë¥˜ ìˆ˜ì • ë‚´ìš©

### ë¬¸ì œ ì§„ë‹¨

**ì˜¤ë¥˜ ë©”ì‹œì§€:**
```
code: "42P17"
message: "infinite recursion detected in policy for relation \"church_members\""
```

### ê·¼ë³¸ ì›ì¸

Row Level Security ì •ì±…ì—ì„œ **ìˆœí™˜ ì°¸ì¡°**ê°€ ë°œìƒ:

```sql
-- âŒ ë¬¸ì œì˜ ì •ì±…
CREATE POLICY "Church members are viewable by church members"
  ON public.church_members FOR SELECT
  USING (
    church_id IN (
      SELECT church_id FROM public.church_members WHERE user_id = auth.uid()
      -- â†‘ church_members í…Œì´ë¸”ì„ ì¡°íšŒí•˜ëŠ” ì •ì±…ì´
      -- â†“ ë‹¤ì‹œ church_members í…Œì´ë¸”ì„ ì¡°íšŒ â†’ ë¬´í•œ ì¬ê·€
    )
  );
```

### í•´ê²° ë°©ë²•

ì •ì±…ì„ ë‘ ê°œë¡œ ë¶„ë¦¬í•˜ì—¬ ì¬ê·€ ë°©ì§€:

```sql
-- âœ… í•´ê²° 1: ìê¸° ìì‹ ì˜ ë©¤ë²„ì‹­ì€ í•­ìƒ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Users can view their own memberships"
  ON public.church_members FOR SELECT
  USING (user_id = auth.uid());
  -- ë‹¨ìˆœ ë¹„êµë¡œ ì¦‰ì‹œ í‰ê°€, ì¬ê·€ ì—†ìŒ

-- âœ… í•´ê²° 2: ê°™ì€ êµíšŒ ë©¤ë²„ ì¡°íšŒ (ëª…ì‹œì  ë³„ì¹­ ì‚¬ìš©)
CREATE POLICY "Users can view members of their churches"
  ON public.church_members FOR SELECT
  USING (
    church_id IN (
      SELECT cm.church_id 
      FROM public.church_members cm  -- ë³„ì¹­ 'cm' ì‚¬ìš©
      WHERE cm.user_id = auth.uid()
    )
  );
```

### ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ë°©ë²•

1. Supabase SQL Editor ì ‘ì†
2. `supabase/migrations/002_fix_rls_policies.sql` ë‚´ìš© ë³µì‚¬
3. ì‹¤í–‰í•˜ì—¬ ì •ì±… ì—…ë°ì´íŠ¸
4. ê°œë°œ ì„œë²„ ì¬ì‹œì‘

---

## ğŸ“Š ëª¨ë‹ˆí„°ë§ ë° ë””ë²„ê¹…

### Supabase ë¡œê·¸ í™•ì¸

1. Dashboard â†’ Logs â†’ API
2. ëŠë¦° ì¿¼ë¦¬ ì‹ë³„
3. RLS ì •ì±… ì—ëŸ¬ í™•ì¸

### í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬ ì²˜ë¦¬

```typescript
try {
  await createPost(data)
} catch (error: any) {
  console.error('Failed to create post:', error)
  
  // ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€
  if (error.code === '42P17') {
    alert('ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • ì˜¤ë¥˜ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.')
  } else {
    alert('ê²Œì‹œë¬¼ ì‘ì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
  }
}
```

---

ì´ ì•„í‚¤í…ì²˜ ë¬¸ì„œëŠ” í”„ë¡œì íŠ¸ì˜ ì „ì²´ êµ¬ì¡°ì™€ ì„¤ê³„ ê²°ì •ì„ ì„¤ëª…í•©ë‹ˆë‹¤. ìƒˆë¡œìš´ ê°œë°œìê°€ í”„ë¡œì íŠ¸ì— ì°¸ì—¬í•˜ê±°ë‚˜, ê¸°ëŠ¥ì„ ì¶”ê°€í•  ë•Œ ì´ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì—¬ ì¼ê´€ëœ êµ¬ì¡°ë¥¼ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

